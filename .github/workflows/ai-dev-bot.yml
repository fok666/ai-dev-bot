name: AI Development Bot

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Specific issue number to work on'
        required: false
      repository:
        description: 'Target repository'
        required: false
  issues:
    types: [opened, labeled, edited, assigned]

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: read

jobs:
  orchestrate:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'ai-bot-task'))
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
        
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm install
          
      - name: Load Configuration
        id: config
        run: |
          node scripts/load-config.js
          
      - name: Find Next Issue
        id: issue
        env:
          GH_API_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "${{ github.event.inputs.issue_number }}" ]; then
            echo "issue_number=${{ github.event.inputs.issue_number }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "issues" ]; then
            echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          else
            node scripts/issue-manager.js find-next-task
          fi
          
      - name: Check if issue found
        id: check_issue
        run: |
          if [ -z "${{ steps.issue.outputs.issue_number }}" ]; then
            echo "No issues to process"
            echo "has_issue=false" >> $GITHUB_OUTPUT
          else
            echo "has_issue=true" >> $GITHUB_OUTPUT
          fi
          
      - name: Load Issue Context
        if: steps.check_issue.outputs.has_issue == 'true'
        id: context
        env:
          GH_API_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          # Load context with target repository information
          node scripts/issue-manager.js load-context \
            --issue="${{ steps.issue.outputs.issue_number }}" \
            --target-owner="${{ steps.issue.outputs.target_owner }}" \
            --target-repo="${{ steps.issue.outputs.target_repo }}"
      
      - name: Checkout Target Repository
        if: steps.check_issue.outputs.has_issue == 'true' && steps.issue.outputs.target_repo && steps.issue.outputs.target_repo != 'ai-dev-bot'
        uses: actions/checkout@v6
        with:
          repository: ${{ steps.issue.outputs.target_repo_full }}
          path: target-repo
          token: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: Update Issue Status to In Progress
        if: steps.check_issue.outputs.has_issue == 'true'
        env:
          GH_API_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          # Use repository context from issue query
          REPO_OPTION=""
          if [ -n "${{ steps.issue.outputs.target_repo_full }}" ]; then
            REPO_OPTION="--repo ${{ steps.issue.outputs.target_repo_full }}"
          fi
          
          gh issue comment "${{ steps.issue.outputs.issue_number }}" $REPO_OPTION \
            --body "ü§ñ **Started execution** at $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          gh issue edit "${{ steps.issue.outputs.issue_number }}" $REPO_OPTION \
            --add-label "status-in-progress" \
            --remove-label "status-ready" || true
          
      - name: Execute Task
        if: steps.check_issue.outputs.has_issue == 'true'
        id: execute
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GH_API_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          node scripts/orchestrator.js execute \
            --issue="${{ steps.issue.outputs.issue_number }}" \
            --context="${{ steps.context.outputs.context_file }}"
            
      - name: Generate Code from Plan
        if: steps.check_issue.outputs.has_issue == 'true' && steps.execute.outputs.has_changes == 'true'
        id: generate
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ü§ñ Generating code from implementation plan..."
          # Construct plan file path matching orchestrator's naming: plan-{owner}-{repo}-{issue}.json
          PLAN_FILE=".context-cache/plan-${{ steps.issue.outputs.target_owner || github.repository_owner }}-${{ steps.issue.outputs.target_repo || github.event.repository.name }}-${{ steps.issue.outputs.issue_number }}.json"
          node scripts/code-generator.js generate \
            --plan="$PLAN_FILE" \
            --context="${{ steps.context.outputs.context_file }}" \
            --issue="${{ steps.issue.outputs.issue_number }}"
          
      - name: Apply Generated Code
        if: steps.check_issue.outputs.has_issue == 'true' && steps.execute.outputs.has_changes == 'true'
        id: apply
        run: |
          echo "üìÇ Applying generated code to repository..."
          node scripts/code-generator.js apply \
            --issue="${{ steps.issue.outputs.issue_number }}"
            
      - name: Create Branch and Commit
        if: steps.check_issue.outputs.has_issue == 'true' && steps.execute.outputs.has_changes == 'true'
        run: |
          # Set working directory based on target repo
          if [ -n "${{ steps.issue.outputs.target_repo }}" ] && [ "${{ steps.issue.outputs.target_repo }}" != "ai-dev-bot" ]; then
            cd target-repo
            echo "üìÇ Working in target repository: ${{ steps.issue.outputs.target_repo_full }}"
          else
            echo "üìÇ Working in bot repository"
          fi
          
          git config --global user.name "AI Dev Bot"
          git config --global user.email "ai-bot@users.noreply.github.com"
          
          BRANCH_NAME="${{ steps.execute.outputs.branch }}"
          git checkout -b "$BRANCH_NAME" || git checkout "$BRANCH_NAME"
          
          # Add all generated files
          git add -A
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "‚ö†Ô∏è  No code changes generated"
            # Create implementation plan as fallback
            echo "# AI-Generated Implementation Plan" > IMPLEMENTATION.md
            echo "" >> IMPLEMENTATION.md
            echo "Issue: #${{ steps.issue.outputs.issue_number }}" >> IMPLEMENTATION.md
            echo "Repository: ${{ steps.issue.outputs.target_repo_full || github.repository }}" >> IMPLEMENTATION.md
            echo "Generated: $(date)" >> IMPLEMENTATION.md
            echo "" >> IMPLEMENTATION.md
            cat ../.context-cache/plan-*.json 2>/dev/null || cat .context-cache/plan-*.json 2>/dev/null || echo "Plan not found"
            git add IMPLEMENTATION.md
            git commit -m "AI-Bot: Implementation plan for issue #${{ steps.issue.outputs.issue_number }}"
          else
            echo "‚úÖ Committing generated code..."
            git commit -m "AI-Bot: Implement solution for issue #${{ steps.issue.outputs.issue_number }}" \
                       -m "Generated by AI Dev Bot" \
                       -m "Issue: #${{ steps.issue.outputs.issue_number }}" \
                       -m "Repository: ${{ steps.issue.outputs.target_repo_full || github.repository }}" \
                       -m "" \
                       -m "This commit contains AI-generated code implementing the solution described in the issue. Please review carefully before merging." \
                       -m "" \
                       -m "Closes #${{ steps.issue.outputs.issue_number }}"
          fi
          
          # Push to the appropriate remote
          if [ -n "${{ steps.issue.outputs.target_repo }}" ] && [ "${{ steps.issue.outputs.target_repo }}" != "ai-dev-bot" ]; then
            # Pushing to target repo (already in target-repo directory)
            git push origin "$BRANCH_NAME" --force
          else
            # Pushing to bot repo
            git push origin "$BRANCH_NAME" --force
          fi
          
      - name: Create/Update PR
        if: steps.check_issue.outputs.has_issue == 'true' && steps.execute.outputs.has_changes == 'true'
        id: pr
        env:
          GH_API_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          node scripts/pr-manager.js create \
            --branch="${{ steps.execute.outputs.branch }}" \
            --title="${{ steps.execute.outputs.pr_title }}" \
            --issue="${{ steps.issue.outputs.issue_number }}" \
            --target-owner="${{ steps.issue.outputs.target_owner }}" \
            --target-repo="${{ steps.issue.outputs.target_repo }}"
            
      - name: Link PR to Issue
        if: steps.check_issue.outputs.has_issue == 'true' && steps.execute.outputs.has_changes == 'true'
        env:
          GH_API_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          # Use repository context for gh commands
          REPO_OPTION=""
          if [ -n "${{ steps.issue.outputs.target_repo_full }}" ]; then
            REPO_OPTION="--repo ${{ steps.issue.outputs.target_repo_full }}"
          fi
          
          gh issue comment "${{ steps.issue.outputs.issue_number }}" $REPO_OPTION \
            --body "üìù Created PR #${{ steps.pr.outputs.pr_number }}: ${{ steps.pr.outputs.pr_url }}"
          gh issue edit "${{ steps.issue.outputs.issue_number }}" $REPO_OPTION \
            --add-label "status-review" \
            --remove-label "status-in-progress" || true
            
      - name: Run Tests
        if: steps.check_issue.outputs.has_issue == 'true' && steps.execute.outputs.has_changes == 'true'
        continue-on-error: true
        run: |
          node scripts/testing.js
          
      - name: Log Metrics to Issue
        if: always() && steps.check_issue.outputs.has_issue == 'true'
        env:
          GH_API_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          node scripts/issue-manager.js log-execution \
            --issue="${{ steps.issue.outputs.issue_number }}" \
            --execution-id="${{ github.run_id }}" \
            --status="${{ job.status }}"
          
      - name: Handle Failure
        if: failure() && steps.check_issue.outputs.has_issue == 'true'
        env:
          GH_API_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          # Use repository context for gh commands
          REPO_OPTION=""
          if [ -n "${{ steps.issue.outputs.target_repo_full }}" ]; then
            REPO_OPTION="--repo ${{ steps.issue.outputs.target_repo_full }}"
          fi
          
          gh issue comment "${{ steps.issue.outputs.issue_number }}" $REPO_OPTION \
            --body "‚ùå **Execution failed**. See [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          gh issue edit "${{ steps.issue.outputs.issue_number }}" $REPO_OPTION \
            --add-label "status-blocked" \
            --remove-label "status-in-progress" || true
