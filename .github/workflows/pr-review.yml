name: AI PR Reviewer

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
  # Removed pull_request_review trigger to prevent infinite loops

permissions:
  contents: read
  pull-requests: write
  issues: read

jobs:
  review:
    runs-on: ubuntu-latest
    if: github.actor != 'ai-dev-bot' && !github.event.pull_request.draft
    timeout-minutes: 15
    
    steps:
      - name: Check if Already Reviewed
        env:
          GH_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          # Check if bot has already reviewed this commit
          PR_NUMBER="${{ github.event.pull_request.number }}"
          CURRENT_SHA="${{ github.event.pull_request.head.sha }}"
          
          echo "Checking for existing reviews on commit $CURRENT_SHA..."
          
          # Get all reviews by github-actions bot
          EXISTING_REVIEW=$(gh api \
            "/repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews" \
            --jq ".[] | select(.user.login == \"github-actions[bot]\" or .user.login == \"ai-dev-bot\") | select(.commit_id == \"$CURRENT_SHA\") | .id" \
            | head -1)
          
          if [ -n "$EXISTING_REVIEW" ]; then
            echo "Skipping: Bot has already reviewed this commit ($CURRENT_SHA)"
            echo "Existing review ID: $EXISTING_REVIEW"
            exit 0
          fi
          
          echo "No existing review found for this commit. Proceeding with review..."
          
      - name: Checkout PR
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm install
          
      - name: Analyze Changes
        id: analyze
        env:
          GH_API_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          node scripts/context-analyzer.js analyze-pr \
            --pr-number="${{ github.event.pull_request.number }}"
            
      - name: Review with Gemini
        id: review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GH_API_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          node scripts/pr-manager.js review \
            --pr-number="${{ github.event.pull_request.number }}" \
            --sdd-path="SDD.md"
            
      - name: Post Review
        if: steps.review.outputs.should_review == 'true'
        env:
          GH_API_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          REVIEW_ACTION="${{ steps.review.outputs.review_action }}"
          
          # Write review body to file to avoid shell escaping issues
          cat << 'REVIEW_EOF' > /tmp/review_body.txt
          ${{ steps.review.outputs.review_body }}
          REVIEW_EOF
          
          # Prevent requesting changes on own PR
          if [ "${{ github.actor }}" = "${{ github.event.pull_request.user.login }}" ] && [ "$REVIEW_ACTION" == "REQUEST_CHANGES" ]; then
            echo "Cannot request changes on own PR; switching to comment."
            REVIEW_ACTION="COMMENT"
          fi
          
          # Post review based on action
          # Note: GitHub Actions cannot approve PRs, so APPROVE becomes COMMENT with recommendation
          if [ "$REVIEW_ACTION" == "APPROVE" ]; then
            echo "" >> /tmp/review_body.txt
            echo "---" >> /tmp/review_body.txt
            echo "âœ… **Recommendation:** This PR looks good and is ready for approval." >> /tmp/review_body.txt
            echo "_(GitHub Actions cannot approve PRs directly - manual approval required)_" >> /tmp/review_body.txt
            gh pr review "${{ github.event.pull_request.number }}" \
              --comment --body-file /tmp/review_body.txt
          elif [ "$REVIEW_ACTION" == "REQUEST_CHANGES" ]; then
            gh pr review "${{ github.event.pull_request.number }}" \
              --request-changes --body-file /tmp/review_body.txt
          else
            gh pr review "${{ github.event.pull_request.number }}" \
              --comment --body-file /tmp/review_body.txt
          fi
