name: Monitor GitHub Actions Pipelines

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:
  # DISABLED: workflow_run to prevent feedback loops and rate limit issues
  # workflow_run:
  #   workflows: ['*']
  #   types: [completed]

permissions:
  actions: read
  issues: write
  contents: read

jobs:
  # CIRCUIT BREAKER: Check if monitoring should run
  check-circuit-breaker:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      reason: ${{ steps.check.outputs.reason }}
    steps:
      - name: Check Recent Monitor Runs
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get recent monitor workflow runs in last hour
          RECENT_RUNS=$(gh run list \
            --repo ${{ github.repository }} \
            --workflow "Monitor GitHub Actions Pipelines" \
            --created ">=$(date -u -d '1 hour ago' '+%Y-%m-%dT%H:%M:%SZ' 2>/dev/null || date -u -v-1H '+%Y-%m-%dT%H:%M:%SZ')" \
            --json conclusion,createdAt \
            --jq 'length')
          
          echo "Recent monitor runs in last hour: $RECENT_RUNS"
          
          # CIRCUIT BREAKER: Max 3 runs per hour
          if [ "$RECENT_RUNS" -ge 3 ]; then
            echo "â›” Circuit breaker OPEN: Too many monitor runs ($RECENT_RUNS in last hour)"
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "reason=Circuit breaker: $RECENT_RUNS runs in last hour (max: 3)" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check for manual dispatch - always allow
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "âœ… Manual dispatch - allowing run"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "reason=Manual dispatch" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check for scheduled run - allow
          if [ "${{ github.event_name }}" == "schedule" ]; then
            echo "âœ… Scheduled run - allowing"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "reason=Scheduled" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Default: don't run
          echo "ðŸš« Not scheduled or manual - skipping"
          echo "should_run=false" >> $GITHUB_OUTPUT
          echo "reason=Not scheduled or manual dispatch" >> $GITHUB_OUTPUT

  monitor:
    runs-on: ubuntu-latest
    needs: check-circuit-breaker
    if: needs.check-circuit-breaker.outputs.should_run == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
        
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm install
          
      - name: Scan for Failed Workflows
        id: scan
        env:
          GH_API_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          # Scan all configured repositories for recent failures
          node scripts/context-analyzer.js scan-pipelines-multi-repo \
            --lookback-hours=24
          
      - name: Analyze Failures
        if: steps.scan.outputs.has_failures == 'true'
        id: analyze
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GH_API_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          # Analyze all recent failures
          node scripts/context-analyzer.js analyze-workflow-failures \
            --failures="${{ steps.scan.outputs.failures_file }}"
      
      - name: Prepare Analysis for Issue Creation
        if: steps.scan.outputs.has_failures == 'true' && steps.analyze.outputs.analyses_file != ''
        id: wrap
        run: |
          # The analyses file is already in the correct format from analyze-workflow-failures
          echo "analyses_file=${{ steps.analyze.outputs.analyses_file }}" >> $GITHUB_OUTPUT
          
      - name: Create Investigation Issues
        if: steps.scan.outputs.has_failures == 'true' && (steps.wrap.outputs.analyses_file != '' || steps.analyze.outputs.analyses_file != '')
        id: create_issues
        continue-on-error: true
        env:
          GH_API_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          # SAFETY: Script creates maximum 1 issue per run to prevent rate limiting
          # - Checks for duplicates FIRST before creating issues
          # - Processes highest priority failure only
          # - Remaining failures handled in next scheduled run
          # - This prevents the feedback loop that caused 50+ duplicate issues
          ANALYSES_FILE="${{ steps.wrap.outputs.analyses_file || steps.analyze.outputs.analyses_file }}"
          
          # Add error handling for rate limits
          if ! node scripts/issue-manager.js create-investigation-issues \
            --analyses="$ANALYSES_FILE"; then
            EXIT_CODE=$?
            echo "âš ï¸ Issue creation failed with exit code: $EXIT_CODE"
            
            # Check if it's a rate limit error
            if [ $EXIT_CODE -eq 1 ]; then
              echo "rate_limited=true" >> $GITHUB_OUTPUT
              echo "ðŸ”´ Likely hit rate limit - circuit breaker will prevent next run"
            fi
            
            # Don't fail the workflow - let circuit breaker handle it
            exit 0
          fi
          
          echo "rate_limited=false" >> $GITHUB_OUTPUT
          
      - name: Summary
        if: always()
        run: |
          echo "## Pipeline Monitoring Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Circuit breaker status
          if [ "${{ needs.check-circuit-breaker.outputs.should_run }}" != "true" ]; then
            echo "â›” **Circuit Breaker: OPEN**" >> $GITHUB_STEP_SUMMARY
            echo "Reason: ${{ needs.check-circuit-breaker.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â„¹ï¸  Monitoring workflow did not run to prevent rate limit issues" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          echo "âœ… Circuit Breaker: CLOSED" >> $GITHUB_STEP_SUMMARY
          echo "Reason: ${{ needs.check-circuit-breaker.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.scan.outputs.has_failures }}" == "true" ]; then
            echo "âœ… Scanned for workflow failures" >> $GITHUB_STEP_SUMMARY
            
            # Check for rate limit
            if [ "${{ steps.create_issues.outputs.rate_limited }}" == "true" ]; then
              echo "âš ï¸  **Rate Limited** - Circuit breaker will prevent next run" >> $GITHUB_STEP_SUMMARY
            elif [ -n "${{ steps.analyze.outputs.issues_created }}" ]; then
              echo "ðŸ“ Created ${{ steps.analyze.outputs.issues_created }} investigation issue(s)" >> $GITHUB_STEP_SUMMARY
            else
              echo "â„¹ï¸  No new investigation issues needed (duplicates found or updated)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âœ“ No recent workflow failures detected" >> $GITHUB_STEP_SUMMARY
          fi
