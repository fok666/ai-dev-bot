name: AI Auto Merge

on:
  pull_request:
    types: [opened, synchronize, labeled]
  check_suite:
    types: [completed]
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.user.login == 'ai-dev-bot' ||
      contains(github.event.pull_request.labels.*.name, 'auto-merge') ||
      contains(github.event.pull_request.labels.*.name, 'ai-generated')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm install
        
      - name: Get PR number
        id: pr
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            # For check_suite events, find the PR
            PR_NUM=$(gh pr list --state open --json number,headRefName \
              --jq ".[] | select(.headRefName==\"${{ github.event.check_suite.head_branch }}\") | .number" \
              | head -n 1)
            echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
          fi
        env:
          GH_API_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
          
      - name: Extract Issue Number
        id: extract
        if: steps.pr.outputs.pr_number != ''
        env:
          GH_API_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          # Extract issue number from PR body using jq
          PR_BODY=$(gh pr view "${{ steps.pr.outputs.pr_number }}" --json body -q '.body')
          
          # Parse issue numbers from common patterns
          ISSUE_NUM=$(echo "$PR_BODY" | grep -oE '(Closes|Fixes|Resolves) #[0-9]+' | head -n 1 | grep -oE '[0-9]+' || echo "")
          
          echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT
          
      - name: Check Merge Conditions
        id: check
        if: steps.pr.outputs.pr_number != ''
        env:
          GH_API_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          node scripts/pr-manager.js check-merge-conditions \
            --pr-number="${{ steps.pr.outputs.pr_number }}"
            
      - name: Merge PR
        if: steps.check.outputs.can_merge == 'true'
        env:
          GH_API_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge "${{ steps.pr.outputs.pr_number }}" \
            --auto --squash \
            --delete-branch || echo "Merge failed or not ready yet"
            
      - name: Update Linked Issue
        if: steps.check.outputs.can_merge == 'true' && steps.extract.outputs.issue_number != ''
        env:
          GH_API_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          # Wait a moment for merge to complete
          sleep 5
          
          # Check if PR was actually merged
          PR_STATE=$(gh pr view "${{ steps.pr.outputs.pr_number }}" --json state -q '.state')
          
          if [ "$PR_STATE" == "MERGED" ]; then
            gh issue comment "${{ steps.extract.outputs.issue_number }}" \
              --body "âœ… **Completed and merged** in PR #${{ steps.pr.outputs.pr_number }}"
            gh issue edit "${{ steps.extract.outputs.issue_number }}" \
              --add-label "status-done" \
              --remove-label "status-review" \
              --remove-label "status-in-progress" || true
            gh issue close "${{ steps.extract.outputs.issue_number }}" \
              --reason completed || true
          fi
